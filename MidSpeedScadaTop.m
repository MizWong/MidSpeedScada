%-------------------------------------------------------------------------%
% Mid Speed SCADA PHY Simulation
% 
%
%
% Miz.Wong ( Miz.Wang@Hytera.com )
% Hytera Co., Ltd.
%
% 2018.3
%-------------------------------------------------------------------------%

clear all;
% close all;
% figure; 
fP = 0;

%% Parameters
M        =   16;
Rs       =   10e3;
Rb       =   Rs * log2(M);
BB_OSR   =   8;
FsBB     =   Rs * BB_OSR;
IF_OSR   =   36;
FsIF     =   FsBB * IF_OSR;

coefRRC  =   [-0.000178159974626982,0.000345282402581159,0.000805593976170785,0.00108562499888833,0.00110366933313571,0.000836771455744646,0.000331936887789862,-0.000298635514615527,-0.000898768283322091,-0.00130258558942761,-0.00137503923369923,-0.00104966595356931,-0.000354234391580373,0.000583262434588692,0.00155208975939973,0.00229854991135651,0.00258159987893374,0.00223344598653263,0.00121179502438385,-0.000369326654050950,-0.00224012041614478,-0.00401116728230087,-0.00524214782159690,-0.00553263150191025,-0.00461835199685720,-0.00245309860775994,0.000743162222715140,0.00448478472580340,0.00807634186845862,0.0107203871931407,0.0116628235999555,0.0103525808318757,0.00658686250737076,0.000612753472704614,-0.00683900853049108,-0.0146022989546505,-0.0212066237387730,-0.0250768633742574,-0.0247743547774144,-0.0192424566064388,-0.00801612815705781,0.00864172896814822,0.0297045707224639,0.0534594928152015,0.0776919572514775,0.0999547215387410,0.117883256722592,0.129511273755130,0.133538735772974,0.129511273755130,0.117883256722592,0.0999547215387410,0.0776919572514775,0.0534594928152015,0.0297045707224639,0.00864172896814822,-0.00801612815705781,-0.0192424566064388,-0.0247743547774144,-0.0250768633742574,-0.0212066237387730,-0.0146022989546505,-0.00683900853049108,0.000612753472704614,0.00658686250737076,0.0103525808318757,0.0116628235999555,0.0107203871931407,0.00807634186845862,0.00448478472580340,0.000743162222715140,-0.00245309860775994,-0.00461835199685720,-0.00553263150191025,-0.00524214782159690,-0.00401116728230087,-0.00224012041614478,-0.000369326654050950,0.00121179502438385,0.00223344598653263,0.00258159987893374,0.00229854991135651,0.00155208975939973,0.000583262434588692,-0.000354234391580373,-0.00104966595356931,-0.00137503923369923,-0.00130258558942761,-0.000898768283322091,-0.000298635514615527,0.000331936887789862,0.000836771455744646,0.00110366933313571,0.00108562499888833,0.000805593976170785,0.000345282402581159,-0.000178159974626982]';
coefIF   =   [-3.56464623046824e-07,-5.67629403379647e-07,-8.46863789177535e-07,-1.20398083384141e-06,-1.64851447463479e-06,-2.18938504736296e-06,-2.83452436269964e-06,-3.59046333918013e-06,-4.46188638534495e-06,-5.45115796413926e-06,-6.55782803542653e-06,-7.77812433406275e-06,-9.10444067610787e-06,-1.05248316674681e-05,-1.20225252893408e-05,-1.35754658242116e-05,-1.51559004354349e-05,-1.67300233933868e-05,-1.82576924233534e-05,-1.96922319075496e-05,-2.09803376807561e-05,-2.20620978933285e-05,-2.28711438572329e-05,-2.33349439244788e-05,-2.33752522612928e-05,-2.29087228688506e-05,-2.18476973608227e-05,-2.01011728435390e-05,-1.75759537663096e-05,-1.41779888336626e-05,-9.81389102063604e-06,-4.39263543581018e-06,2.17257373008995e-06,9.96227960795726e-06,1.90486086416070e-05,2.94929862676821e-05,4.13437562619663e-05,5.46337315554565e-05,6.93777080323178e-05,8.55699763455735e-05,0.000103181870055109,0.000122159391335588,0.000142420958049008,0.000163855318059061,0.000186319678216497,0.000209638096404120,0.000233600185340517,0.000257960176452471,0.000282436390994869,0.000306711163689499,0.000330431261446342,0.000353208836208922,0.000374622946627053,0.000394221678115465,0.000411524884928154,0.000426027571201166,0.000437203920539582,0.000444511975709393,0.000447398961416374,0.000445307234098707,0.000437680833226876,0.000423972598902558,0.000403651810697279,0.000376212292799233,0.000341180920777694,0.000298126455769198,0.000246668622781990,0.000186487341250559,0.000117332008096112,3.90307265038331e-05,-4.85006324472768e-05,-0.000145249653140373,-0.000251099005351120,-0.000365818604755878,-0.000489058429002152,-0.000620342113789343,-0.000759061451287422,-0.000904471909468612,-0.00105568928551409,-0.00121168759937687,-0.00137129832484820,-0.00153321104512524,-0.00169597560797297,-0.00185800584219636,-0.00201758488239583,-0.00217287213299888,-0.00232191188549095,-0.00246264358478080,-0.00259291372191486,-0.00271048931110681,-0.00281307288948966,-0.00289831895835848,-0.00296385176519054,-0.00300728430665094,-0.00302623841436391,-0.00301836576769952,-0.00298136966143792,-0.00291302734116431,-0.00281121270584620,-0.00267391916546293,-0.00249928243199326,-0.00228560301469856,-0.00203136818562060,-0.00173527317867497,-0.00139624138576661,-0.00101344331605529,-0.000586314089899015,-0.000114569247111669,0.000401781340035696,0.000962421645219772,0.00156671993806860,0.00221372166758636,0.00290214492019611,0.00363037857090316,0.00439648322153639,0.00519819499387189,0.00603293221795193,0.00689780502737137,0.00778962784402233,0.00870493470508895,0.00963999735529959,0.0105908459979167,0.0115532925690150,0.0125229563716083,0.0134952918794725,0.0144656184953937,0.0154291520253661,0.0163810376092577,0.0173163838299247,0.0182302977069306,0.0191179202681279,0.0199744623825610,0.0207952405316113,0.0215757121921149,0.0223115105054306,0.0229984779101361,0.0236326984231755,0.0242105282648257,0.0247286245366842,0.0251839716788952,0.0255739054528279,0.0258961342182206,0.0261487572991381,0.0263302802607083,0.0264396269481906,0.0264761481711672,0.0264396269481906,0.0263302802607083,0.0261487572991381,0.0258961342182206,0.0255739054528279,0.0251839716788952,0.0247286245366842,0.0242105282648257,0.0236326984231755,0.0229984779101361,0.0223115105054306,0.0215757121921149,0.0207952405316113,0.0199744623825610,0.0191179202681279,0.0182302977069306,0.0173163838299247,0.0163810376092577,0.0154291520253661,0.0144656184953937,0.0134952918794725,0.0125229563716083,0.0115532925690150,0.0105908459979167,0.00963999735529959,0.00870493470508895,0.00778962784402233,0.00689780502737137,0.00603293221795193,0.00519819499387189,0.00439648322153639,0.00363037857090316,0.00290214492019611,0.00221372166758636,0.00156671993806860,0.000962421645219772,0.000401781340035696,-0.000114569247111669,-0.000586314089899015,-0.00101344331605529,-0.00139624138576661,-0.00173527317867497,-0.00203136818562060,-0.00228560301469856,-0.00249928243199326,-0.00267391916546293,-0.00281121270584620,-0.00291302734116431,-0.00298136966143792,-0.00301836576769952,-0.00302623841436391,-0.00300728430665094,-0.00296385176519054,-0.00289831895835848,-0.00281307288948966,-0.00271048931110681,-0.00259291372191486,-0.00246264358478080,-0.00232191188549095,-0.00217287213299888,-0.00201758488239583,-0.00185800584219636,-0.00169597560797297,-0.00153321104512524,-0.00137129832484820,-0.00121168759937687,-0.00105568928551409,-0.000904471909468612,-0.000759061451287422,-0.000620342113789343,-0.000489058429002152,-0.000365818604755878,-0.000251099005351120,-0.000145249653140373,-4.85006324472768e-05,3.90307265038331e-05,0.000117332008096112,0.000186487341250559,0.000246668622781990,0.000298126455769198,0.000341180920777694,0.000376212292799233,0.000403651810697279,0.000423972598902558,0.000437680833226876,0.000445307234098707,0.000447398961416374,0.000444511975709393,0.000437203920539582,0.000426027571201166,0.000411524884928154,0.000394221678115465,0.000374622946627053,0.000353208836208922,0.000330431261446342,0.000306711163689499,0.000282436390994869,0.000257960176452471,0.000233600185340517,0.000209638096404120,0.000186319678216497,0.000163855318059061,0.000142420958049008,0.000122159391335588,0.000103181870055109,8.55699763455735e-05,6.93777080323178e-05,5.46337315554565e-05,4.13437562619663e-05,2.94929862676821e-05,1.90486086416070e-05,9.96227960795726e-06,2.17257373008995e-06,-4.39263543581018e-06,-9.81389102063604e-06,-1.41779888336626e-05,-1.75759537663096e-05,-2.01011728435390e-05,-2.18476973608227e-05,-2.29087228688506e-05,-2.33752522612928e-05,-2.33349439244788e-05,-2.28711438572329e-05,-2.20620978933285e-05,-2.09803376807561e-05,-1.96922319075496e-05,-1.82576924233534e-05,-1.67300233933868e-05,-1.51559004354349e-05,-1.35754658242116e-05,-1.20225252893408e-05,-1.05248316674681e-05,-9.10444067610787e-06,-7.77812433406275e-06,-6.55782803542653e-06,-5.45115796413926e-06,-4.46188638534495e-06,-3.59046333918013e-06,-2.83452436269964e-06,-2.18938504736296e-06,-1.64851447463479e-06,-1.20398083384141e-06,-8.46863789177535e-07,-5.67629403379647e-07,-3.56464623046824e-07]';

hMod     =   comm.RectangularQAMModulator( M, 'BitInput', true );
hDem     =   comm.RectangularQAMDemodulator( M, 'BitOutput', true );

T        =   0.02;

nTSHead  =   20;
nFTSDvd  =   20;
nFTSLen  =   1;

tBB      =   0 : 1/FsBB : T - 1/FsBB;
tIF      =   0 : 1/FsIF : T - 1/FsIF;

txcPPM   =   1;
txcFreq  =   100e3;
txcFreq  =   txcFreq + (txcFreq / 1e6)*txcPPM;
txcPhi0  =   0;

rxcFreq  =   100e3;
rxcPhi0  =   pi/3;

dSpped   =   350;
fd       =   20;%( txcFreq * dSpped ) / 3e8;
pdb      =   [0 -22.3];
tau      =   [0 5e-6];
RlChan   =   rayleighchan( (1 / FsIF), fd, tau, pdb);

hEVM     =   comm.EVM( 'ReferenceSignalSource', 'Estimated from reference constellation', ...
                       'ReferenceConstellation', constellation(hMod).' );

hMyDFE   =   fnDFECreate(10, 5, 0.99, hMod, hDem);

%% Transmitter
txBit    =   randi( [0,1], T*Rb, 1 );
txSym    =   step(hMod, txBit );
txSymUp  =   zeros( length(txSym)*BB_OSR, 1 );
txSymUp(1 : BB_OSR : end) = txSym;
txSymUp  =   txSymUp * BB_OSR;

txSymUp  =   [zeros(200,1); txSymUp; zeros(200,1);];

txSymUp  =   FilterConv( txSymUp.', coefRRC' ).' ;

txSymIF  =   zeros( length(txSymUp)*IF_OSR, 1 );
txSymIF(1 : IF_OSR : end) = txSymUp;
txSymIF  =   txSymIF * IF_OSR;
txSymIF  =   FilterConv( txSymIF.', coefIF' ).' ;
% txSymIF  =   txSymIF .* exp( 1j*( 2*pi*txcFreq*tIF' + txcPhi0 ) );

%% Channel
rxSymIF  =   txSymIF;
rxSymIF  =   filter( RlChan, rxSymIF );
% rxSymIF  =   awgn( rxSymIF, 0, 'measured' );

%% Receiver
% rxSymIF  =   rxSymIF ./ exp( 1j*( 2*pi*rxcFreq*tIF' + rxcPhi0 ) );
rxSymIF  =   FilterConv( rxSymIF.', coefIF' ).' ;
rxSymUp  =   zeros( length(rxSymIF) / IF_OSR, 1 );
rxSymUp  =   rxSymIF( 1 : IF_OSR : end );

fP=fP+1;subplot(3,3,fP);psd(spectrum.periodogram, rxSymUp, 'Fs',FsBB, 'CenterDC',true);title('PSD RX');

rxSymUp  =   FilterConv( rxSymUp.', coefRRC' ).';

fP=fP+1;subplot(3,3,fP);plot(rxSymUp,'.');title('Post RRC');

for ii   =   1:1:BB_OSR
    avePwr(ii) = mean(abs(rxSymUp(ii:BB_OSR:end)));
end
[max T0] =   max(avePwr);

rxSymUp  =   rxSymUp(201:end-200);

rxSym    =   rxSymUp(T0:BB_OSR:end);

fprintf( 'T0 = %d\r\n', T0 );

fP=fP+1;subplot(3,3,fP);plot(rxSym,'.');title('Post DownSample');
fprintf( 'EVM Post-DownSample = %f%%\r\n', hEVM(rxSym(nTSHead+1:end)) );

hAGC = comm.AGC('DesiredOutputPower', 10, 'AveragingLength', 20);
rxSym = step(hAGC, rxSym);


fP=fP+1;subplot(3,3,fP);plot(rxSym(nTSHead+1:end),'.');title('Post AGC');

nField = 0;
for ii = 1 : nFTSDvd : length(rxSym)
    nField = nField + 1;
    FldErr(nField) = mean( txSym(ii:ii+nFTSLen)./rxSym(ii:ii+nFTSLen) );
end
FldErr = [FldErr,mean( txSym(end)./rxSym(end) )];

symErr = interp1([1 : nFTSDvd : length(rxSym),length(rxSym)], FldErr.', [1 : length(rxSym)+1], 'linear').';%resample(FldErr,nFTSDvd,1).';
symErr = symErr(1:length(rxSym));

fP=fP+1;subplot(3,3,fP);stem(abs( txSym./rxSym ));hold on;plot(abs(symErr),'linewidth',3);hold off;title('Field Sync Magnitude Error');
fP=fP+1;subplot(3,3,fP);stem(phase( txSym./rxSym ));hold on;plot(phase(symErr),'linewidth',3);hold off;title('Field Sync Phase Error');

rxSym = rxSym .* symErr;

fP=fP+1;subplot(3,3,fP);plot(rxSym,'.');title('Post Field Sync');

fprintf( 'EVM Post-Filed Sync = %f%%\r\n', hEVM(rxSym) );

[hMyDFE, rxSym, vyDcs] = fnDFE( hMyDFE, rxSym, [1:nTSHead], txSym );
vyDcs = step( hDem, rxSym ).';

fP=fP+1;subplot(3,3,fP);plot(rxSym(nTSHead+1:end),'.');title('Post Equalize');

fP=fP+1;subplot(3,3,fP);stem(real(hMyDFE.e));hold on;stem(imag(hMyDFE.e));hold off;title('Equalizer error');

fprintf( 'EVM Post-EQ = %f%%\r\n', hEVM(rxSym(nTSHead+1:end)) );

BER = (sum( vyDcs(nTSHead*log2(M)+1:end)' ~= txBit(nTSHead*log2(M)+1:end) ) / length(txBit(nTSHead*log2(M)+1:end))) * 100
%hs = spectrum.periodogram; figure;psd(hs, rxSym, 'Fs',FSIF, 'CenterDC',true)
