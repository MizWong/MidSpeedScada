%-------------------------------------------------------------------------%
% Mid Speed SCADA PHY Simulation
% 
%
%
% Miz.Wong ( Miz.Wang@Hytera.com )
% Hytera Co., Ltd.
%
% 2018.3
%-------------------------------------------------------------------------%

clear all;
close all;
figure; fP = 0;

%% Parameters
M        =   16;
Rs       =   10e3;
Rb       =   Rs * log2(M);
BB_OSR   =   8;
FsBB     =   Rs * BB_OSR;
IF_OSR   =   36;
FsIF     =   FsBB * IF_OSR;

coefRRC  =   [-0.000593866582089949,-0.000519178823944003,-0.000307699650483779,2.21345461246340e-06,0.000345155278913264,0.000642233109974616,0.000818884587771089,0.000823014597700411,0.000639151389527122,0.000294953981745590,-0.000142051034444981,-0.000577464052384724,-0.000910387433274922,-0.00105690067175509,-0.000971290586782011,-0.000659806118215797,-0.000183064939475338,0.000354382182865520,0.000825900038269464,0.00111177353217541,0.00112904695336971,0.000855121191294227,0.000338871703412072,-0.000304572965002331,-0.000915753993388131,-0.00132595736521047,-0.00139843265630219,-0.00106657566684062,-0.000359630274176309,0.000591650595676181,0.00157313025628947,0.00232787183764440,0.00261253441190733,0.00225853664726686,0.00122453175737747,-0.000372950590826472,-0.00226059256440084,-0.00404522305227608,-0.00528338406635161,-0.00557283649152548,-0.00464925758407685,-0.00246816369564769,0.000747334927470697,0.00450771296350467,0.00811376852963964,0.0107651950380023,0.0117065485295115,0.0103871815329314,0.00660635327708625,0.000614346285288944,-0.00685448762220582,-0.0146307840696393,-0.0212418585314602,-0.0251118609371785,-0.0248029199554365,-0.0192604225200106,-0.00802204011582344,0.00864660740050646,0.0297168881475067,0.0534748844001800,0.0777062709764141,0.0999650790240016,0.117888685302681,0.129512764698294,0.133538735772974,0.129512764698294,0.117888685302681,0.0999650790240016,0.0777062709764141,0.0534748844001800,0.0297168881475067,0.00864660740050646,-0.00802204011582344,-0.0192604225200106,-0.0248029199554365,-0.0251118609371785,-0.0212418585314602,-0.0146307840696393,-0.00685448762220582,0.000614346285288944,0.00660635327708625,0.0103871815329314,0.0117065485295115,0.0107651950380023,0.00811376852963964,0.00450771296350467,0.000747334927470697,-0.00246816369564769,-0.00464925758407685,-0.00557283649152548,-0.00528338406635161,-0.00404522305227608,-0.00226059256440084,-0.000372950590826472,0.00122453175737747,0.00225853664726686,0.00261253441190733,0.00232787183764440,0.00157313025628947,0.000591650595676181,-0.000359630274176309,-0.00106657566684062,-0.00139843265630219,-0.00132595736521047,-0.000915753993388131,-0.000304572965002331,0.000338871703412072,0.000855121191294227,0.00112904695336971,0.00111177353217541,0.000825900038269464,0.000354382182865520,-0.000183064939475338,-0.000659806118215797,-0.000971290586782011,-0.00105690067175509,-0.000910387433274922,-0.000577464052384724,-0.000142051034444981,0.000294953981745590,0.000639151389527122,0.000823014597700411,0.000818884587771089,0.000642233109974616,0.000345155278913264,2.21345461246340e-06,-0.000307699650483779,-0.000519178823944003,-0.000593866582089949]';
coefIF   =   [2.89420106699409e-21,9.04626555805899e-07,2.30213395261237e-06,4.28233473221837e-06,6.93609370400073e-06,1.03530348848112e-05,1.46189459471616e-05,1.98129022032036e-05,2.60041405831850e-05,3.32487226342898e-05,4.15860341039599e-05,5.10351770047620e-05,6.15913180012326e-05,7.32220643235456e-05,8.58639450073872e-05,9.94190808953794e-05,0.000113752131330086,0.000128687608649338,0.000144007653302635,0.000159450362501712,0.000174708763679894,0.000189430520569297,0.000203218454346696,0.000215631955013408,0.000226189348961134,0.000234371277569022,0.000239625128748946,0.000241370548715321,0.000239006045049372,0.000231916674539224,0.000219482790525582,0.000201089804820325,0.000176138898975012,0.000144058599067616,0.000104317107581411,5.64352657199827e-05,-1.70731695150794e-19,-6.53219114417747e-05,-0.000139769934328248,-0.000223475932114916,-0.000316450587783391,-0.000418570313486980,-0.000529564875559247,-0.000649005966876572,-0.000776296959709701,-0.000910664069814097,-0.00105114915645136,-0.00119660437321357,-0.00134568887090694,-0.00149686773636773,-0.00164841333002224,-0.00179840916041628,-0.00194475640604433,-0.00208518316388176,-0.00221725647040365,-0.00233839710495325,-0.00244589714754921,-0.00253694022408425,-0.00260862433190235,-0.00265798709851071,-0.00268203328627843,-0.00267776431699976,-0.00264220955277205,-0.00257245903436445,-0.00246569734573378,-0.00231923824415261,-0.00213055967009629,-0.00189733873009104,-0.00161748622960724,-0.00128918032218024,-0.000910898835582519,-0.000481449836304528,7.12382819558233e-19,0.000533899631999991,0.00112029091150159,0.00175878923453249,0.00244856793140467,0.00318834670672744,0.00397638439946178,0.00481047628752494,0.00568795611169534,0.00660570294022668,0.00756015293931791,0.00854731605611983,0.00956279756105243,0.0106018243356584,0.0116592757318517,0.0127297187690692,0.0138074473783347,0.0148865253474176,0.0159608325699110,0.0170241141539257,0.0180700319038991,0.0190922176524095,0.0200843278884304,0.0210400991046648,0.0219534032698542,0.0228183028225908,0.0236291045813621,0.0243804119714427,0.0250671749827998,0.0256847372942895,0.0262288800278612,0.0266958616319343,0.0270824534351245,0.0273859704595643,0.0276042971365550,0.0277359076255265,0.0277798804994881,0.0277359076255265,0.0276042971365550,0.0273859704595643,0.0270824534351245,0.0266958616319343,0.0262288800278612,0.0256847372942895,0.0250671749827998,0.0243804119714427,0.0236291045813621,0.0228183028225908,0.0219534032698542,0.0210400991046648,0.0200843278884304,0.0190922176524095,0.0180700319038991,0.0170241141539257,0.0159608325699110,0.0148865253474176,0.0138074473783347,0.0127297187690692,0.0116592757318517,0.0106018243356584,0.00956279756105243,0.00854731605611983,0.00756015293931791,0.00660570294022668,0.00568795611169534,0.00481047628752494,0.00397638439946178,0.00318834670672744,0.00244856793140467,0.00175878923453249,0.00112029091150159,0.000533899631999991,7.12382819558233e-19,-0.000481449836304528,-0.000910898835582519,-0.00128918032218024,-0.00161748622960724,-0.00189733873009104,-0.00213055967009629,-0.00231923824415261,-0.00246569734573378,-0.00257245903436445,-0.00264220955277205,-0.00267776431699976,-0.00268203328627843,-0.00265798709851071,-0.00260862433190235,-0.00253694022408425,-0.00244589714754921,-0.00233839710495325,-0.00221725647040365,-0.00208518316388176,-0.00194475640604433,-0.00179840916041628,-0.00164841333002224,-0.00149686773636773,-0.00134568887090694,-0.00119660437321357,-0.00105114915645136,-0.000910664069814097,-0.000776296959709701,-0.000649005966876572,-0.000529564875559247,-0.000418570313486980,-0.000316450587783391,-0.000223475932114916,-0.000139769934328248,-6.53219114417747e-05,-1.70731695150794e-19,5.64352657199827e-05,0.000104317107581411,0.000144058599067616,0.000176138898975012,0.000201089804820325,0.000219482790525582,0.000231916674539224,0.000239006045049372,0.000241370548715321,0.000239625128748946,0.000234371277569022,0.000226189348961134,0.000215631955013408,0.000203218454346696,0.000189430520569297,0.000174708763679894,0.000159450362501712,0.000144007653302635,0.000128687608649338,0.000113752131330086,9.94190808953794e-05,8.58639450073872e-05,7.32220643235456e-05,6.15913180012326e-05,5.10351770047620e-05,4.15860341039599e-05,3.32487226342898e-05,2.60041405831850e-05,1.98129022032036e-05,1.46189459471616e-05,1.03530348848112e-05,6.93609370400073e-06,4.28233473221837e-06,2.30213395261237e-06,9.04626555805899e-07,2.89420106699409e-21]';

hMod     =   comm.RectangularQAMModulator( M, 'BitInput', true );
hDem     =   comm.RectangularQAMDemodulator( M, 'BitOutput', true );

T        =   1;

nTSHead  =   200;
nFTSDvd  =   20;
nFTSLen  =   1;

tBB      =   0 : 1/FsBB : T - 1/FsBB;
tIF      =   0 : 1/FsIF : T - 1/FsIF;

txcPPM   =   1;
txcFreq  =   100e3;
txcFreq  =   txcFreq + (txcFreq / 1e6)*txcPPM;
txcPhi0  =   0;

rxcFreq  =   100e3;
rxcPhi0  =   pi/3;

dSpped   =   350;
fd       =   20;%( txcFreq * dSpped ) / 3e8;
pdb      =   [0 -22.3];
tau      =   [0 5e-6];
RlChan   =   rayleighchan( (1 / FsIF), fd, tau, pdb);

hDFE     =   dfe( 10, 10, rls(0.995), constellation(hMod).' );

hEVM     =   comm.EVM();

hMyDFE   =   fnDFECreate(10, 10, 0.995, hMod, hDem);

%% Transmitter
txBit    =   randi( [0,1], T*Rb, 1 );
txSym    =   step(hMod, txBit );
txSymUp  =   zeros( length(txSym)*BB_OSR, 1 );
txSymUp(1 : BB_OSR : end) = txSym;
txSymUp  =   txSymUp * BB_OSR;
txSymUp  =   FilterConv( txSymUp.', coefRRC' ).' ;

txSymIF  =   zeros( length(txSymUp)*IF_OSR, 1 );
txSymIF(1 : IF_OSR : end) = txSymUp;
txSymIF  =   txSymIF * IF_OSR;
txSymIF  =   FilterConv( txSymIF.', coefIF' ).' ;
txSymIF  =   txSymIF .* exp( 1j*( 2*pi*txcFreq*tIF' + txcPhi0 ) );

%% Channel
rxSymIF  =   txSymIF;
rxSymIF  =   filter( RlChan, rxSymIF );
rxSymIF  =   awgn( rxSymIF, 0, 'measured' );

%% Receiver
rxSymIF  =   rxSymIF ./ exp( 1j*( 2*pi*rxcFreq*tIF' + rxcPhi0 ) );
rxSymIF  =   FilterConv( rxSymIF.', coefIF' ).' ;
rxSymUp  =   zeros( length(rxSymIF) / IF_OSR, 1 );
rxSymUp  =   rxSymIF( 1 : IF_OSR : end );

fP=fP+1;subplot(3,3,fP);psd(spectrum.periodogram, rxSymUp, 'Fs',FsBB, 'CenterDC',true);title('PSD RX');

fP=fP+1;subplot(3,3,fP);plot(rxSymUp,'.');title('Pre RRC');

rxSymUp  =   FilterConv( rxSymUp.', coefRRC' ).';

fP=fP+1;subplot(3,3,fP);plot(rxSymUp,'.');title('Post RRC');

for ii   =   1:1:BB_OSR
    avePwr(ii) = mean(abs(rxSymUp(ii:BB_OSR:end)));
end
[max T0] =   max(avePwr);
rxSym    =   rxSymUp(T0:BB_OSR:end);

fprintf( 'T0 = %d\r\n', T0 );

fP=fP+1;subplot(3,3,fP);plot(rxSym,'.');title('Post DownSample');
fprintf( 'EVM Post-DownSample = %f%%\r\n', step(hEVM, step(hMod,step(hDem,rxSym)), rxSym) );

nField = 0;
for ii = 1 : nFTSDvd : length(rxSym)
    nField = nField + 1;
    FldErr(nField) = mean( txSym(ii:ii+nFTSLen)./rxSym(ii:ii+nFTSLen) );
end

symErr = resample(FldErr,nFTSDvd,1).';

rxSym = rxSym .* symErr;

fP=fP+1;subplot(3,3,fP);plot(rxSym,'.');title('Post Field Sync');

nWeights = 1;  
stepSize = 0.0001;  
alg = cma(stepSize);  
eqCMA = lineareq(nWeights,alg); 
eqCMA.SigConst = constellation(hMod).';
eqCMA.leakagefactor = 1;  
eqCMA.Weights = [zeros(1,length(eqCMA.Weights)-1),1];   
rxSym    =   equalize( eqCMA, rxSym, txSym(1:nTSHead) );

fP=fP+1;subplot(3,3,fP);plot(rxSym,'.');title('Post CMA');

[hMyDFE, rxSym, vyDcs] = fnDFE( hMyDFE, rxSym, [1:nTSHead], txSym );
vyDcs = step( hDem, rxSym ).';

fP=fP+1;subplot(3,3,fP);plot(rxSym(nTSHead+1:end),'.');title('Post Equalize');

fprintf( 'EVM Post-EQ = %f%%\r\n', step(hEVM, step(hMod,step(hDem,rxSym)), rxSym) );
 
BER = (sum( vyDcs(nTSHead*log2(M)+1:end)' ~= txBit(nTSHead*log2(M)+1:end) ) / length(txBit(nTSHead*log2(M)+1:end))) * 100
%hs = spectrum.periodogram; figure;psd(hs, rxSym, 'Fs',FSIF, 'CenterDC',true)
